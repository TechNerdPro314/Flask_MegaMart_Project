input {
  # Прием логов от Filebeat
  beats {
    port => 5044
  }

  # Прямой прием JSON логов из Docker
  tcp {
    port => 5000
    codec => json_lines
    type => docker
  }
}

filter {
  # Обработка Flask логов
  if [app] == "megamart" and [logger] == "flask.app" {
    mutate {
      add_field => { "log_source" => "flask_application" }
    }
    
    # Извлекаем компонент из сообщения
    if [message] =~ /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} flask.app:
      grok {
        match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:logger_name}: %{GREEDYDATA:message}" }
      }
    }
    
    # Парсим уровень логирования
    if [levelname] {
      mutate {
        uppercase => [ "levelname" ]
      }
    }
  }
  
  # Обработка Nginx логов
  if [log_type] == "nginx_access" {
    mutate {
      add_field => { "log_source" => "nginx_access" }
    }
    
    if [source] =~ "access.log" {
      grok {
        match => {
          "message" => '%{IPORHOST:client_ip} - %{DATA:user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{URIPATHPARAM:request} HTTP/%{NUMBER:http_version}" %{NUMBER:status:int} %{NUMBER:bytes:int} "%{DATA:referrer}" "%{DATA:user_agent}" %{NUMBER:request_time:float}'
        }
      }
    }
    
    # Геолокация по IP (опционально)
    if [client_ip] {
      geoip {
        source => "client_ip"
        target => "geoip"
        add_tag => ["geoip"]
        database => "/usr/share/GeoIP/GeoLite2-City.mmdb"
      }
    }
    
    useragent {
      source => "user_agent"
      target => "ua"
    }
  }
  
  # Обработка MySQL логов
  if [log_type] == "mysql" or [source] =~ "mysql" {
    mutate {
      add_field => { "log_source" => "mysql" }
    }
    
    # Slow query log
    if [source] =~ "slow" {
      grok {
        match => {
          "message" => "# Time: %{TIMESTAMP_ISO8601:mysql_time}\n# User@Host: %{DATA:user}\[%{DATA}\] @ %{DATA:host} \[%{IP:ip}\]\n# Query_time: %{NUMBER:query_time:float}  Lock_time: %{NUMBER:lock_time:float} Rows_sent: %{NUMBER:rows_sent:int}  Rows_examined: %{NUMBER:rows_examined:int}\n%{GREEDYDATA:query}"
        }
      }
      mutate {
        add_tag => ["mysql_slow_query"]
      }
    }
  }
  
  # Добавляем timestamp если нет
  if ![@timestamp] {
    date {
      match => ["timestamp", "ISO8601", "dd/MMM/yyyy:HH:mm:ss Z"]
      target => "@timestamp"
    }
  }
  
  # Нормализация уровня логирования
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }
  
  # Извлекаем service info
  mutate {
    add_field => {
      "service" => "megamart"
      "environment" => "production"
    }
  }
}

output {
  # Elasticsearch вывод
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "megamart-logs-%{+YYYY.MM.dd}"
    document_type => "%{[@metadata][type]}"
  }
  
  # stdout для отладки
  stdout {
    codec => rubydebug
  }
}
