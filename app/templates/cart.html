{% extends "base.html" %}

{% block title %}Корзина{% endblock %}

{% block content %}
<h1 class="mb-4 fw-bold">Корзина</h1>

{% if cart_items %}
<div class="row">
    <!-- Cart Items List -->
    <div class="col-lg-8">
        {% for item in cart_items %}
        <!-- Determine product object and quantity depending on session or db cart -->
        {% if current_user.is_authenticated %}
        {% set product = item.product %}
        {% set qty = item.quantity %}
        {% else %}
        {% set product = item %}
        {% set qty = item.quantity %}
        {% endif %}

        <div class="cart-item-card">
            <div class="row align-items-center g-3">
                <!-- Image -->
                <div class="col-3 col-md-2">
                    <a href="{{ url_for('main.product', product_id=product.id) }}">
                        <img src="{{ url_for('static', filename='images/' + (product.first_image if product.first_image else product.image_url if product.image_url else 'default_product.png')) }}"
                            alt="{{ product.name }}" class="cart-img">
                    </a>
                </div>

                <!-- Info -->
                <div class="col-9 col-md-4">
                    <a href="{{ url_for('main.product', product_id=product.id) }}"
                        class="text-decoration-none text-dark">
                        <h5 class="fs-6 fw-bold mb-1">{{ product.name }}</h5>
                    </a>
                    <p class="text-muted small mb-0">Артикул: {{ product.id }}</p>
                </div>

                <!-- Quantity -->
                <div class="col-6 col-md-3">
                    <form action="{{ url_for('cart_app.update_cart', product_id=product.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="quantity-control">
                            <button type="submit" name="quantity" value="{{ qty - 1 }}" class="quantity-btn"><i
                                    class="fas fa-minus small"></i></button>
                            <input type="text" class="quantity-input" value="{{ qty }}" readonly>
                            <button type="submit" name="quantity" value="{{ qty + 1 }}" class="quantity-btn"><i
                                    class="fas fa-plus small"></i></button>
                        </div>
                    </form>
                </div>

                <!-- Price & Remove -->
                <div class="col-6 col-md-3 text-end">
                    <div class="fw-bold mb-2">{{ "{:,.0f}".format(product.price * qty).replace(',', ' ') }} ₽</div>
                    <a href="{{ url_for('cart_app.remove_from_cart', product_id=product.id) }}"
                        class="text-danger small text-decoration-none">
                        <i class="fas fa-trash-alt me-1"></i> Удалить
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Summary Sidebar -->
    <div class="col-lg-4">
        <div class="cart-summary shadow-sm">
            <h4 class="fw-bold mb-4">Ваш заказ</h4>

            <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Товары ({{ cart_items|length }})</span>
                <span>{{ "{:,.0f}".format(total_price).replace(',', ' ') }} ₽</span>
            </div>

            {% if discount_amount > 0 %}
            <div class="d-flex justify-content-between mb-2 text-success">
                <span>Скидка</span>
                <span>-{{ "{:,.0f}".format(discount_amount).replace(',', ' ') }} ₽</span>
            </div>
            {% endif %}

            <hr class="my-3">

            <div class="d-flex justify-content-between mb-4">
                <span class="fs-5 fw-bold">Итого</span>
                <span class="fs-4 fw-bold text-primary">{{ "{:,.0f}".format(final_price).replace(',', ' ') }} ₽</span>
            </div>

            <a href="{{ url_for('cart_app.checkout') }}"
                class="btn btn-primary w-100 py-3 fw-bold mb-3 rounded-3 shadow-sm">
                Перейти к оформлению
            </a>

            <a href="{{ url_for('main.catalog') }}" class="btn btn-outline-secondary w-100 border-0">
                Продолжить покупки
            </a>

            <!-- Promo Code Section -->
            <div class="mt-4 pt-4 border-top">
                {% if promo_code_info %}
                <div class="alert alert-success d-flex justify-content-between align-items-center p-2 small">
                    <div>
                        <i class="fas fa-tag me-1"></i>
                        Промокод <strong>{{ promo_code_info.code }}</strong> применен
                    </div>
                    <a href="{{ url_for('cart_app.remove_promo') }}" class="btn-close btn-sm" aria-label="Close"></a>
                </div>
                {% else %}
                <form action="{{ url_for('cart_app.apply_promo') }}" method="post" class="input-group">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="text" name="promo_code" class="form-control" placeholder="Промокод">
                    <button class="btn btn-outline-secondary" type="submit">Применить</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Empty State -->
<div class="text-center py-5">
    <div class="mb-4">
        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center"
            style="width: 120px; height: 120px;">
            <i class="fas fa-shopping-basket fa-3x text-muted opacity-50"></i>
        </div>
    </div>
    <h2 class="fw-bold mb-3">В корзине пока пусто</h2>
    <p class="text-muted mb-4">Загляните в каталог, там много интересного сантехнического оборудования.</p>
    <a href="{{ url_for('main.catalog') }}" class="btn btn-primary btn-lg px-5 rounded-pill">
        Перейти в каталог
    </a>
</div>
{% endif %}

{% endblock %}