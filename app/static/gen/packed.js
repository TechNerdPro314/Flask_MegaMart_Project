document.addEventListener('DOMContentLoaded',()=>{const themeToggleBtn=document.getElementById('theme-toggle');const htmlElement=document.documentElement;const icon=themeToggleBtn?themeToggleBtn.querySelector('i'):null;const savedTheme=localStorage.getItem('theme');const systemPrefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;let currentTheme=savedTheme||(systemPrefersDark?'dark':'light');applyTheme(currentTheme,false);if(themeToggleBtn){themeToggleBtn.addEventListener('click',()=>{currentTheme=currentTheme==='light'?'dark':'light';applyTheme(currentTheme,true);localStorage.setItem('theme',currentTheme);createRipple(themeToggleBtn);});}
function applyTheme(theme,animate=true){if(animate){htmlElement.style.transition='background-color 0.3s ease, color 0.3s ease';}
htmlElement.setAttribute('data-bs-theme',theme);if(icon){if(theme==='dark'){icon.classList.remove('fa-moon');icon.classList.add('fa-sun');}else{icon.classList.remove('fa-sun');icon.classList.add('fa-moon');}}
if(animate){setTimeout(()=>{htmlElement.style.transition='';},300);}
window.dispatchEvent(new CustomEvent('themeChanged',{detail:{theme}}));}
function createRipple(button){const ripple=document.createElement('span');const diameter=Math.max(button.clientWidth,button.clientHeight);const radius=diameter/2;ripple.style.width=ripple.style.height=`${diameter}px`;ripple.style.left='50%';ripple.style.top='50%';ripple.style.transform='translate(-50%, -50%) scale(0)';ripple.style.position='absolute';ripple.style.borderRadius='50%';ripple.style.backgroundColor='rgba(255, 255, 255, 0.6)';ripple.style.pointerEvents='none';ripple.style.animation='ripple-animation 0.6s ease-out';button.style.position='relative';button.style.overflow='hidden';button.appendChild(ripple);setTimeout(()=>ripple.remove(),600);}
if(!document.getElementById('ripple-styles')){const style=document.createElement('style');style.id='ripple-styles';style.textContent=`@keyframes ripple-animation{to{transform:translate(-50%,-50%)scale(2);opacity:0;}}`;document.head.appendChild(style);}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',e=>{if(!localStorage.getItem('theme')){currentTheme=e.matches?'dark':'light';applyTheme(currentTheme,true);}});const swUrl=document.body.getAttribute('data-sw-url');if('serviceWorker'in navigator&&swUrl){window.addEventListener('load',()=>{navigator.serviceWorker.register(swUrl).then(registration=>{console.log('ServiceWorker registration successful with scope: ',registration.scope);}).catch(err=>{console.log('ServiceWorker registration failed: ',err);});});}
const tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipTriggerList.map(function(tooltipTriggerEl){return new bootstrap.Tooltip(tooltipTriggerEl);});const mainImage=document.getElementById('mainProductImage');const thumbBtns=document.querySelectorAll('.gallery-thumb-btn');if(mainImage&&thumbBtns.length>0){thumbBtns.forEach(btn=>{btn.addEventListener('click',function(){thumbBtns.forEach(b=>b.classList.remove('active'));this.classList.add('active');const newSrc=this.getAttribute('data-image-url');mainImage.style.opacity='0.5';setTimeout(()=>{mainImage.src=newSrc;mainImage.style.opacity='1';},200);});});}
document.body.addEventListener('click',function(e){if(e.target.closest('.quantity-btn')){const btn=e.target.closest('.quantity-btn');const input=btn.parentElement.querySelector('.quantity-input');const type=btn.getAttribute('data-type');if(input){let val=parseInt(input.value)||1;if(type==='minus'){val=val>1?val-1:1;}else{val=val+1;}
input.value=val;if(input.hasAttribute('onchange')){input.dispatchEvent(new Event('change'));}}}});const wishlistCounter=document.querySelector('.wishlist-count');document.body.addEventListener('click',function(e){const btn=e.target.closest('.btn-wishlist')||e.target.closest('.btn-wishlist-remove');if(!btn)return;e.preventDefault();const productId=btn.getAttribute('data-product-id');const isRemoveBtn=btn.classList.contains('btn-wishlist-remove');fetch('/api/wishlist/toggle',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':document.querySelector('meta[name="csrf-token"]').getAttribute('content')},body:JSON.stringify({product_id:parseInt(productId)})}).then(response=>{if(response.status===401){window.location.href='/auth/login';return;}
return response.json();}).then(data=>{if(data&&data.success){if(isRemoveBtn){const col=document.getElementById(`wishlist-item-${productId}`);if(col){col.remove();const remaining=document.querySelectorAll('[id^="wishlist-item-"]');if(remaining.length===0)location.reload();}}
else{const icon=btn.querySelector('i');if(data.action==='added'){icon.classList.remove('far');icon.classList.add('fas','text-danger');icon.classList.add('animate__animated','animate__heartBeat');}else{icon.classList.remove('fas','text-danger','animate__animated','animate__heartBeat');icon.classList.add('far');}}
if(wishlistCounter){let count=parseInt(wishlistCounter.innerText)||0;if(data.action==='added'){count++;}else if(data.action==='removed'&&count>0){count--;}
if(count>0){wishlistCounter.innerText=count;wishlistCounter.classList.remove('d-none');}else{wishlistCounter.classList.add('d-none');}}}}).catch(error=>console.error('Error:',error));});});class CartManager{constructor(){this.csrfToken=this.getCsrfToken();this.initEventListeners();}
getCsrfToken(){return document.querySelector('meta[name="csrf-token"]')?.content||'';}
initEventListeners(){document.addEventListener('click',(e)=>{if(e.target.classList.contains('add-to-cart-btn')){e.preventDefault();const productId=e.target.dataset.productId;const quantity=parseInt(e.target.dataset.quantity||1);this.addToCart(productId,quantity);}});document.addEventListener('change',(e)=>{if(e.target.classList.contains('cart-quantity-input')){const productId=e.target.dataset.productId;const quantity=parseInt(e.target.value);this.updateCart(productId,quantity);}});document.addEventListener('click',(e)=>{if(e.target.classList.contains('remove-from-cart-btn')){e.preventDefault();const productId=e.target.dataset.productId;this.removeFromCart(productId);}});}
async addToCart(productId,quantity=1){try{const response=await fetch('/api/cart/add',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':this.csrfToken},body:JSON.stringify({product_id:productId,quantity:quantity})});const data=await response.json();if(data.success){this.showNotification(data.message,'success');this.updateCartCount(data.cart_count);}else{this.showNotification(data.error||'Ошибка','danger');}}catch(error){console.error('Error:',error);this.showNotification('Произошла ошибка','danger');}}
async updateCart(productId,quantity){try{const response=await fetch('/api/cart/update',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':this.csrfToken},body:JSON.stringify({product_id:productId,quantity:quantity})});const data=await response.json();if(data.success){this.updateTotalPrice(data.total_price);this.updateCartCount(data.cart_count);}else{this.showNotification(data.error||'Ошибка','danger');location.reload();}}catch(error){console.error('Error:',error);location.reload();}}
async removeFromCart(productId){if(!confirm('Удалить товар из корзины?'))return;try{const response=await fetch('/api/cart/remove',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':this.csrfToken},body:JSON.stringify({product_id:productId})});const data=await response.json();if(data.success){location.reload();}else{this.showNotification(data.error||'Ошибка','danger');}}catch(error){console.error('Error:',error);this.showNotification('Произошла ошибка','danger');}}
updateCartCount(count){const cartCountElements=document.querySelectorAll('.cart-count');cartCountElements.forEach(el=>{el.textContent=count;el.style.display=count>0?'block':'none';});}
updateTotalPrice(price){const totalElements=document.querySelectorAll('.cart-total-price');totalElements.forEach(el=>{el.textContent=`${price.toFixed(2)}₽`;});}
showNotification(message,type='info'){const alertDiv=document.createElement('div');alertDiv.className=`alert alert-${type}alert-dismissible fade show position-fixed top-0 end-0 m-3`;alertDiv.style.zIndex='1050';alertDiv.style.minWidth='250px';alertDiv.innerHTML=`${message}<button type="button"class="btn-close"data-bs-dismiss="alert"></button>`;document.body.appendChild(alertDiv);setTimeout(()=>{alertDiv.remove();},3000);}}
document.addEventListener('DOMContentLoaded',()=>{new CartManager();});