document.addEventListener('DOMContentLoaded', () => {
    const themeToggle = document.getElementById('theme-toggle'); const themeIcon = document.getElementById('theme-icon'); const currentTheme = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-bs-theme', currentTheme); if (currentTheme === 'dark') { if (themeIcon) { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); } }
    if (themeToggle) { themeToggle.addEventListener('click', () => { let theme = document.documentElement.getAttribute('data-bs-theme'); if (theme === 'light') { document.documentElement.setAttribute('data-bs-theme', 'dark'); localStorage.setItem('theme', 'dark'); themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); } else { document.documentElement.setAttribute('data-bs-theme', 'light'); localStorage.setItem('theme', 'light'); themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon'); } }); }
    document.querySelectorAll('.wishlist-toggle-btn').forEach(button => { button.addEventListener('click', function (e) { e.preventDefault(); const productId = this.dataset.productId; const icon = this.querySelector('i'); const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content'); fetch('/api/wishlist/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }, body: JSON.stringify({ product_id: parseInt(productId) }) }).then(response => response.json()).then(data => { if (data.success) { if (data.action === 'added') { icon.classList.remove('fa-regular'); icon.classList.add('fa-solid', 'text-danger'); } else { icon.classList.remove('fa-solid', 'text-danger'); icon.classList.add('fa-regular'); } } }).catch(error => console.error('Error:', error)); }); }); const searchInput = document.getElementById('search-input'); const suggestionsContainer = document.getElementById('autocomplete-container'); const searchForm = document.getElementById('search-form'); if (searchInput && suggestionsContainer && searchForm) {
        searchInput.addEventListener('input', function (e) {
            const query = e.target.value; if (query.length < 2) { suggestionsContainer.innerHTML = ''; return; }
            fetch(`/api/search/autocomplete?q=${encodeURIComponent(query)}`).then(response => response.json()).then(data => { suggestionsContainer.innerHTML = ''; if (data.length > 0) { const suggestionsList = document.createElement('div'); suggestionsList.className = 'list-group position-absolute top-100 start-0 w-100'; suggestionsList.style.zIndex = '1050'; data.forEach(item => { const suggestionItem = document.createElement('a'); suggestionItem.href = item.url; suggestionItem.className = 'list-group-item list-group-item-action'; suggestionItem.textContent = item.name; suggestionsList.appendChild(suggestionItem); }); suggestionsContainer.appendChild(suggestionsList); } });
        }); document.addEventListener('click', function (e) { if (!searchForm.contains(e.target)) { suggestionsContainer.innerHTML = ''; } });
    }
    if ('serviceWorker' in navigator) { const swUrl = document.body.dataset.swUrl; if (swUrl) { window.addEventListener('load', () => { navigator.serviceWorker.register(swUrl).then(reg => console.log('Service worker registered.', reg)).catch(err => console.log('Service worker registration failed: ', err)); }); } }
}); class CartManager {
    constructor() { this.csrfToken = this.getCsrfToken(); this.initEventListeners(); }
    getCsrfToken() { return document.querySelector('meta[name="csrf-token"]')?.content || ''; }
    initEventListeners() { document.addEventListener('click', (e) => { if (e.target.classList.contains('add-to-cart-btn')) { e.preventDefault(); const productId = e.target.dataset.productId; const quantity = parseInt(e.target.dataset.quantity || 1); this.addToCart(productId, quantity); } }); document.addEventListener('change', (e) => { if (e.target.classList.contains('cart-quantity-input')) { const productId = e.target.dataset.productId; const quantity = parseInt(e.target.value); this.updateCart(productId, quantity); } }); document.addEventListener('click', (e) => { if (e.target.classList.contains('remove-from-cart-btn')) { e.preventDefault(); const productId = e.target.dataset.productId; this.removeFromCart(productId); } }); }
    async addToCart(productId, quantity = 1) { try { const response = await fetch('/api/cart/add', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken }, body: JSON.stringify({ product_id: productId, quantity: quantity }) }); const data = await response.json(); if (data.success) { this.showNotification(data.message, 'success'); this.updateCartCount(data.cart_count); } else { this.showNotification(data.error || 'Ошибка', 'danger'); } } catch (error) { console.error('Error:', error); this.showNotification('Произошла ошибка', 'danger'); } }
    async updateCart(productId, quantity) { try { const response = await fetch('/api/cart/update', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken }, body: JSON.stringify({ product_id: productId, quantity: quantity }) }); const data = await response.json(); if (data.success) { this.updateTotalPrice(data.total_price); this.updateCartCount(data.cart_count); } else { this.showNotification(data.error || 'Ошибка', 'danger'); location.reload(); } } catch (error) { console.error('Error:', error); location.reload(); } }
    async removeFromCart(productId) { if (!confirm('Удалить товар из корзины?')) return; try { const response = await fetch('/api/cart/remove', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.csrfToken }, body: JSON.stringify({ product_id: productId }) }); const data = await response.json(); if (data.success) { location.reload(); } else { this.showNotification(data.error || 'Ошибка', 'danger'); } } catch (error) { console.error('Error:', error); this.showNotification('Произошла ошибка', 'danger'); } }
    updateCartCount(count) { const cartCountElements = document.querySelectorAll('.cart-count'); cartCountElements.forEach(el => { el.textContent = count; el.style.display = count > 0 ? 'block' : 'none'; }); }
    updateTotalPrice(price) { const totalElements = document.querySelectorAll('.cart-total-price'); totalElements.forEach(el => { el.textContent = `${price.toFixed(2)}₽`; }); }
    showNotification(message, type = 'info') { const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type}alert-dismissible fade show position-fixed top-0 end-0 m-3`; alertDiv.style.zIndex = '1050'; alertDiv.style.minWidth = '250px'; alertDiv.innerHTML = `${message}<button type="button"class="btn-close"data-bs-dismiss="alert"></button>`; document.body.appendChild(alertDiv); setTimeout(() => { alertDiv.remove(); }, 3000); }
}
document.addEventListener('DOMContentLoaded', () => { new CartManager(); });